<!DOCTYPE html><html class=no-js lang=en> <head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta content="Addressing horizontal scalability concerns, we've benchmarked PostgresML and ended up with an incredible 1 million requests per second using commodity hardware." name=description><meta content="Lev Kokotov" name=author><link href=https://postgresml.org/blog/scaling-postgresml-to-one-million-requests-per-second/ rel=canonical><link href=/images/owl.ico rel=icon><meta content="mkdocs-1.4.2, mkdocs-material-8.5.10" name=generator><meta content=PostgresML property=og:site_name><meta content="Scaling PostgresML to 1 Million Requests per Second" property=og:title><meta content="Addressing horizontal scalability concerns, we've benchmarked PostgresML and ended up with an incredible 1 million requests per second using commodity hardware." property=og:description><meta content="Lev Kokotov" property=og:author><meta content=https://static.postgresml.org/benchmarks/Slow-Down-Sign.jpg property=og:image><meta content="PostgresML at 1 million requests per second" property=og:image:alt><meta content=article property=og:type><title>Scaling PostgresML to 1 Million Requests per Second - PostgresML</title><link href=../../assets/stylesheets/main.975780f9.min.css rel=stylesheet><link href=../../assets/stylesheets/palette.2505c338.min.css rel=stylesheet><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback" rel=stylesheet><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link href=../../stylesheets/extra.css rel=stylesheet><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script async data-website-id=499122fd-f307-4e8d-af4b-88b9f5e9903b defer src=https://data.cloud.hyperparam.ai/umami.js>
</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><link href=../../assets/stylesheets/glightbox.min.css rel=stylesheet><style>
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            
                .gscrollbar-fixer { padding-right: 15px; }
                .gdesc-inner { font-size: 0.75rem; }
                body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
                body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
                body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
                </style><script src=../../assets/javascripts/glightbox.min.js></script></head> <body data-md-color-accent=blue data-md-color-primary=indigo data-md-color-scheme=default dir=ltr> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input autocomplete=off class=md-toggle data-md-toggle=drawer id=__drawer type=checkbox> <input autocomplete=off class=md-toggle data-md-toggle=search id=__search type=checkbox> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a class=md-skip href=#scaling-postgresml-to-1-million-requests-per-second> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav aria-label=Header class="md-header__inner md-grid"> <a aria-label=PostgresML class="md-header__button md-logo" data-md-component=logo href=../.. title=PostgresML> <img alt=logo src=/images/owl_white.png> </a> <label class="md-header__button md-icon" for=__drawer> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Postgres<span style="color: dodgerblue">ML</span> </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Scaling PostgresML to 1 Million Requests per Second </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input aria-label="Switch to dark mode" class=md-option data-md-color-accent=blue data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary=indigo data-md-color-scheme=default id=__palette_1 name=__palette type=radio> <label class="md-header__button md-icon" for=__palette_2 hidden title="Switch to dark mode"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"></path></svg> </label> <input aria-label="Switch to light mode" class=md-option data-md-color-accent=blue data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary=blue data-md-color-scheme=slate id=__palette_2 name=__palette type=radio> <label class="md-header__button md-icon" for=__palette_1 hidden title="Switch to light mode"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"></path></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input aria-label=Search autocapitalize=off autocomplete=off autocorrect=off class=md-search__input data-md-component=search-query name=query placeholder=Search required spellcheck=false type=text> <label class="md-search__icon md-icon" for=__search> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg> </label> <nav aria-label=Search class=md-search__options> <button aria-label=Clear class="md-search__icon md-icon" tabindex=-1 title=Clear type=reset> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a class=md-source data-md-component=source href=https://github.com/postgresml/postgresml title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg> </div> <div class=md-source__repository> postgresml/postgresml </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav aria-label=Tabs class=md-tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a class=md-tabs__link href=../..> PostgresML </a> </li> <li class=md-tabs__item> <a href=../../user_guides/setup/quick_start_with_docker/ class=md-tabs__link> User Guides </a> </li> <li class=md-tabs__item> <a href=../../developer_guide/overview/ class=md-tabs__link> Developer Guide </a> </li> <li class=md-tabs__item> <a href=../data-is-living-and-relational/ class="md-tabs__link md-tabs__link--active"> Blog </a> </li> <li class=md-tabs__item> <a href=../../about/team/ class=md-tabs__link> About </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav aria-label=Navigation class="md-nav md-nav--primary md-nav--lifted" data-md-level=0> <label class=md-nav__title for=__drawer> <a aria-label=PostgresML class="md-nav__button md-logo" data-md-component=logo href=../.. title=PostgresML> <img alt=logo src=/images/owl_white.png> </a> Postgres<span style="color: dodgerblue">ML</span> </label> <div class=md-nav__source> <a class=md-source data-md-component=source href=https://github.com/postgresml/postgresml title="Go to repository"> <div class="md-source__icon md-icon"> <svg viewbox="0 0 448 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg> </div> <div class=md-source__repository> postgresml/postgresml </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=../..> PostgresML </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 id=__nav_2 type=checkbox> <label class=md-nav__link for=__nav_2> User Guides <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="User Guides" class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> User Guides </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_1 id=__nav_2_1 type=checkbox> <label class=md-nav__link for=__nav_2_1> Setup <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Setup class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> Setup </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../user_guides/setup/quick_start_with_docker/ class=md-nav__link> Quick Start with Docker </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_1_2 id=__nav_2_1_2 type=checkbox> <label class=md-nav__link for=__nav_2_1_2> Installation <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Installation class=md-nav data-md-level=3> <label class=md-nav__title for=__nav_2_1_2> <span class="md-nav__icon md-icon"></span> Installation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../user_guides/setup/v2/installation/ class=md-nav__link> v2.0 </a> </li> <li class=md-nav__item> <a href=../../user_guides/setup/v2/upgrade-from-v1/ class=md-nav__link> Upgrading from v1.0 to v2.0 </a> </li> <li class=md-nav__item> <a href=../../user_guides/setup/installation/ class=md-nav__link> v1.0 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../user_guides/setup/distributed_training/ class=md-nav__link> Distributed Training </a> </li> <li class=md-nav__item> <a href=../../user_guides/setup/gpu_support/ class=md-nav__link> GPU Support </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2 id=__nav_2_2 type=checkbox> <label class=md-nav__link for=__nav_2_2> Training <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Training class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> Training </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../user_guides/training/overview/ class=md-nav__link> Training Overview </a> </li> <li class=md-nav__item> <a href=../../user_guides/training/algorithm_selection/ class=md-nav__link> Algorithm Selection </a> </li> <li class=md-nav__item> <a href=../../user_guides/training/preprocessing/ class=md-nav__link> Preprocessing Data </a> </li> <li class=md-nav__item> <a href=../../user_guides/training/hyperparameter_search/ class=md-nav__link> Hyperparameter Search </a> </li> <li class=md-nav__item> <a href=../../user_guides/training/joint_optimization/ class=md-nav__link> Joint Optimization </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_3 id=__nav_2_3 type=checkbox> <label class=md-nav__link for=__nav_2_3> Predictions <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Predictions class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> Predictions </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../user_guides/predictions/overview/ class=md-nav__link> Prediction Overview </a> </li> <li class=md-nav__item> <a href=../../user_guides/predictions/batch/ class=md-nav__link> Batch Predictions </a> </li> <li class=md-nav__item> <a href=../../user_guides/predictions/deployments/ class=md-nav__link> Deploying Models </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../user_guides/vector_operations/overview/ class=md-nav__link> Vector Operations </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_5 id=__nav_2_5 type=checkbox> <label class=md-nav__link for=__nav_2_5> Transformers <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Transformers class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_5> <span class="md-nav__icon md-icon"></span> Transformers </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../user_guides/transformers/setup/ class=md-nav__link> Setup </a> </li> <li class=md-nav__item> <a href=../../user_guides/transformers/pre_trained_models/ class=md-nav__link> Pre-Trained Models </a> </li> <li class=md-nav__item> <a href=../../user_guides/transformers/fine_tuning/ class=md-nav__link> Fine Tuning </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../user_guides/dashboard/overview/ class=md-nav__link> Dashboard </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_7 id=__nav_2_7 type=checkbox> <label class=md-nav__link for=__nav_2_7> Schema <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Schema class=md-nav data-md-level=2> <label class=md-nav__title for=__nav_2_7> <span class="md-nav__icon md-icon"></span> Schema </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../user_guides/schema/models/ class=md-nav__link> Models </a> </li> <li class=md-nav__item> <a href=../../user_guides/schema/snapshots/ class=md-nav__link> Snapshots </a> </li> <li class=md-nav__item> <a href=../../user_guides/schema/projects/ class=md-nav__link> Projects </a> </li> <li class=md-nav__item> <a href=../../user_guides/schema/deployments/ class=md-nav__link> Deployments </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 id=__nav_3 type=checkbox> <label class=md-nav__link for=__nav_3> Developer Guide <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Developer Guide" class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Developer Guide </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../developer_guide/overview/ class=md-nav__link> Developer Overview </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input checked class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 id=__nav_4 type=checkbox> <label class=md-nav__link for=__nav_4> Blog <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=Blog class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Blog </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../data-is-living-and-relational/ class=md-nav__link> Data is Living and Relational </a> </li> <li class=md-nav__item> <a href=../postgres-full-text-search-is-awesome/ class=md-nav__link> Postgres Full Text Search is Awesome </a> </li> <li class=md-nav__item> <a href=../which-database-that-is-the-question/ class=md-nav__link> Which Database, That is the Question </a> </li> <li class=md-nav__item> <a href=../oxidizing-machine-learning/ class=md-nav__link> Oxidizing Machine Learning </a> </li> <li class=md-nav__item> <a href=../postgresml-is-moving-to-rust-for-our-2.0-release/ class=md-nav__link> PostgresML is Moving to Rust for our 2.0 Release </a> </li> <li class=md-nav__item> <a href=../backwards-compatible-or-bust-python-inside-rust-inside-postgres/ class=md-nav__link> Backwards Compatible or Bust: Python Inside Rust Inside Postgres </a> </li> <li class=md-nav__item> <a href=../postgresml-is-8x-faster-than-python-http-microservices/ class=md-nav__link> PostgresML is 8-40x faster than Python HTTP microservices </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc id=__toc type=checkbox> <label class="md-nav__link md-nav__link--active" for=__toc> Scaling PostgresML to 1 Million Requests per Second <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Scaling PostgresML to 1 Million Requests per Second </a> <nav aria-label="Table of contents" class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=#architecture-overview> Architecture Overview </a> <nav aria-label="Architecture Overview" class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#clients> Clients </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#load-balancer> Load Balancer </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#pgcat> PgCat </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#postgres-replicas> Postgres Replicas </a> <nav aria-label="Postgres Replicas" class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#parallelizing-xgboost> Parallelizing XGBoost </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a class=md-nav__link href=#results> Results </a> <nav aria-label=Results class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#linear-scaling> Linear Scaling </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#batching-predictions> Batching Predictions </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#graceful-degradation-and-queuing> Graceful Degradation and Queuing </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a class=md-nav__link href=#whats-next> What's Next </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#methodology> Methodology </a> <nav aria-label=Methodology class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#ml> ML </a> <nav aria-label=ML class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#model> Model </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a class=md-nav__link href=#hardware> Hardware </a> <nav aria-label=Hardware class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#client> Client </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#pgcat-pooler> PgCat Pooler </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#postgres-replicas_1> Postgres Replicas </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#raw-results> Raw Results </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a class=md-nav__link href=#call-to-early-adopters> Call to Early Adopters </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 id=__nav_5 type=checkbox> <label class=md-nav__link for=__nav_5> About <span class="md-nav__icon md-icon"></span> </label> <nav aria-label=About class=md-nav data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> About </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../about/team/ class=md-nav__link> Team </a> </li> <li class=md-nav__item> <a href=../../about/roadmap/ class=md-nav__link> Roadmap </a> </li> <li class=md-nav__item> <a href=../../about/motivation/ class=md-nav__link> Motivation </a> </li> <li class=md-nav__item> <a href=../../about/faq/ class=md-nav__link> FAQ </a> </li> <li class=md-nav__item> <a href=../../about/license/ class=md-nav__link> License </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav aria-label="Table of contents" class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a class=md-nav__link href=#architecture-overview> Architecture Overview </a> <nav aria-label="Architecture Overview" class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#clients> Clients </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#load-balancer> Load Balancer </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#pgcat> PgCat </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#postgres-replicas> Postgres Replicas </a> <nav aria-label="Postgres Replicas" class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#parallelizing-xgboost> Parallelizing XGBoost </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a class=md-nav__link href=#results> Results </a> <nav aria-label=Results class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#linear-scaling> Linear Scaling </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#batching-predictions> Batching Predictions </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#graceful-degradation-and-queuing> Graceful Degradation and Queuing </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a class=md-nav__link href=#whats-next> What's Next </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#methodology> Methodology </a> <nav aria-label=Methodology class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#ml> ML </a> <nav aria-label=ML class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#model> Model </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a class=md-nav__link href=#hardware> Hardware </a> <nav aria-label=Hardware class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a class=md-nav__link href=#client> Client </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#pgcat-pooler> PgCat Pooler </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#postgres-replicas_1> Postgres Replicas </a> </li> <li class=md-nav__item> <a class=md-nav__link href=#raw-results> Raw Results </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a class=md-nav__link href=#call-to-early-adopters> Call to Early Adopters </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a class="md-content__button md-icon" href=https://github.com/postgresml/postgresml/blob/master/pgml-docs/docs/blog/scaling-postgresml-to-one-million-requests-per-second.md title="Edit this page"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"></path></svg> </a> <h1 id=scaling-postgresml-to-1-million-requests-per-second>Scaling PostgresML to 1 Million Requests per Second<a class=headerlink href=#scaling-postgresml-to-1-million-requests-per-second title="Permanent link">¶</a></h1> <p class=author> <a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=/images/team/lev.jpg><img alt=Author height=54px src=/images/team/lev.jpg width=54px></a> Lev Kokotov<br> November 7, 2022 </p> <p>The question "Does it Scale?" has become somewhat of a meme in software engineering. There is a good reason for it though, because most businesses plan for success. If your app, online store, or SaaS becomes popular, you want to be sure that the system powering it can serve all your new customers.</p> <p>At PostgresML, we are very concerned with scale. Our engineering background took us through scaling PostgreSQL to 100 TB+, so we're certain that it scales, but could we scale machine learning alongside it?</p> <p>In this post, we'll discuss how we horizontally scale PostgresML to achieve more than <strong>1 million XGBoost predictions per second</strong> on commodity hardware.</p> <p>If you missed our previous post and are wondering why someone would combine machine learning and Postgres, take a look at our PostgresML vs. Python <a href=/blog/postgresml-is-8x-faster-than-python-http-microservices>benchmark</a>.</p> <h2 id=architecture-overview>Architecture Overview<a class=headerlink href=#architecture-overview title="Permanent link">¶</a></h2> <p>If you're familiar with how one runs PostgreSQL at scale, you can skip straight to the <a href=#results>results</a>.</p> <p>Part of our thesis, and the reason why we chose Postgres as our host for machine learning, is that scaling machine learning inference is very similar to scaling read queries in a typical database cluster.</p> <p>Inference speed varies based on the model complexity (e.g. <code>n_estimators</code> for XGBoost) and the size of the dataset (how many features the model uses), which is analogous to query complexity and table size in the database world and, as we'll demonstrate further on, scaling the latter is mostly a solved problem.</p> <p><center> <a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=/images/illustrations/scaling-postgresml-3.svg><img alt="Scaling PostgresML" src=/images/illustrations/scaling-postgresml-3.svg></a> <br> <em>System Architecture</em> </center></p> <table> <thead> <tr> <th>Component</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td>Clients</td> <td>Regular Postgres clients</td> </tr> <tr> <td>ELB</td> <td><a href=https://aws.amazon.com/elasticloadbalancing/ >Elastic Network Load Balancer</a></td> </tr> <tr> <td>PgCat</td> <td>A Postgres <a href=https://github.com/levkk/pgcat/ >pooler</a> with built-in load balancing, failover, and sharding</td> </tr> <tr> <td>Replica</td> <td>Regular Postgres <a href=https://www.postgresql.org/docs/current/high-availability.html>replicas</a></td> </tr> <tr> <td>Primary</td> <td>Regular Postgres primary</td> </tr> </tbody> </table> <p>Our architecture has four components that may need to scale up or down based on load:</p> <ol> <li>Clients</li> <li>Load balancer</li> <li><a href=https://github.com/levkk/pgcat/ >PgCat</a> pooler</li> <li>Postgres replicas</li> </ol> <p>We intentionally don't discuss scaling the primary in this post, because sharding, which is the most effective way to do so, is a fascinating subject that deserves its own series of posts. Spoiler alert: we sharded Postgres without any problems.</p> <h3 id=clients>Clients<a class=headerlink href=#clients title="Permanent link">¶</a></h3> <p>Clients are regular Postgres connections coming from web apps, job queues, or pretty much anywhere that needs data. They can be long-living or ephemeral and they typically grow in number as the application scales.</p> <p>Most modern deployments use containers which are added as load on the app increases, and removed as the load decreases. This is called dynamic horizontal scaling, and it's an effective way to adapt to changing traffic patterns experienced by most businesses.</p> <h3 id=load-balancer>Load Balancer<a class=headerlink href=#load-balancer title="Permanent link">¶</a></h3> <p>The load balancer is a way to spread traffic across horizontally scalable components, by routing new connections to targets in a round robin (or random) fashion. It's typically a very large box (or a fast router), but even those need to be scaled if traffic suddenly increases. Since we're running our system on AWS, this is already taken care of, for a reasonably small fee, by using an Elastic Load Balancer.</p> <h3 id=pgcat>PgCat<a class=headerlink href=#pgcat title="Permanent link">¶</a></h3> <p><center> <a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=https://raw.githubusercontent.com/levkk/pgcat/main/pgcat3.png><img alt=PgCat height=300 src=https://raw.githubusercontent.com/levkk/pgcat/main/pgcat3.png width=auto></a> <br> <em>Meow. All your Postgres belong to me.</em> </center></p> <p>If you've used Postgres in the past, you know that it can't handle many concurrent connections. For large deployments, it's necessary to run something we call a pooler. A pooler routes thousands of clients to only a few dozen server connections by time-sharing when a client can use a server. Because most queries are very quick, this is a very effective way to run Postgres at scale.</p> <p>There are many poolers available presently, the most notable being PgBouncer, which has been around for a very long time, and is trusted by many large organizations. Unfortunately, it hasn't evolved much with the growing needs of highly available Postgres deployments, so we wrote <a href=https://github.com/levkk/pgcat/ >our own</a> which added important functionality we needed:</p> <ul> <li>Load balancing of read queries</li> <li>Failover in case a read replica is broken</li> <li>Sharding (this feature is still being developed)</li> </ul> <p>In this benchmark, we used its load balancing feature to evenly distribute XGBoost predictions across our Postgres replicas.</p> <h3 id=postgres-replicas>Postgres Replicas<a class=headerlink href=#postgres-replicas title="Permanent link">¶</a></h3> <p>Scaling Postgres reads is pretty straight forward. If more read queries are coming in, we add a replica to serve the increased load. If the load is decreasing, we remove a replica to save money. The data is replicated from the primary, so all replicas are identical, and all of them can serve any query, or in our case, an XGBoost prediction. PgCat can dynamically add and remove replicas from its config without disconnecting clients, so we can add and remove replicas as needed, without downtime.</p> <h4 id=parallelizing-xgboost>Parallelizing XGBoost<a class=headerlink href=#parallelizing-xgboost title="Permanent link">¶</a></h4> <p>Scaling XGBoost predictions is a little bit more interesting. XGBoost cannot serve predictions concurrently because of internal data structure locks. This is common to many other machine learning algorithms as well, because making predictions can temporarily modify internal components of the model.</p> <p>PostgresML bypasses that limitation because of how Postgres itself handles concurrency:</p> <p><center> <a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=/images/illustrations/postgres-multiprocess-2.png><img alt="Inside a replica" height=300 src=/images/illustrations/postgres-multiprocess-2.png style="height: 300px" width=auto></a> <br> <em>PostgresML concurrency</em> </center></p> <p>PostgreSQL uses the fork/multiprocessing architecture to serve multiple clients concurrently: each new client connection becomes an independent OS process. During connection startup, PostgresML loads all models inside the process' memory space. This means that each connection has its own copy of the XGBoost model and PostgresML ends up serving multiple XGBoost predictions at the same time without any lock contention.</p> <h2 id=results>Results<a class=headerlink href=#results title="Permanent link">¶</a></h2> <p>We ran over a 100 different benchmarks, by changing the number of clients, poolers, replicas, and XGBoost predictions we requested. The benchmarks were meant to test the limits of each configuration, and what remediations were needed in each scenario. Our raw data is available <a href=#methodology>below</a>.</p> <p>One of the tests we ran used 1,000 clients, which were connected to 1, 2, and 5 replicas. The results were exactly what we expected.</p> <h3 id=linear-scaling>Linear Scaling<a class=headerlink href=#linear-scaling title="Permanent link">¶</a></h3> <p><center> <iframe frameborder=0 height=371 scrolling=no seamless src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRm4aEylX8xMNmO-HFFxr67gbZDQ8rh_vss1HvX0tWAUD_zxkwYYNhiBObT1LVe8m6ELZ0seOzmH0ZL/pubchart?oid=2028066210&format=interactive" width=600></iframe> </center></p> <p><center> <iframe frameborder=0 height=371 scrolling=no seamless src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRm4aEylX8xMNmO-HFFxr67gbZDQ8rh_vss1HvX0tWAUD_zxkwYYNhiBObT1LVe8m6ELZ0seOzmH0ZL/pubchart?oid=1442564288&format=interactive" width=600></iframe> </center></p> <p>Both latency and throughput, the standard measurements of system performance, scale mostly linearly with the number of replicas. Linear scaling is the north star of all horizontally scalable systems, and most are not able to achieve it because of increasing complexity that comes with synchronization.</p> <p>Our architecture shares nothing and requires no synchronization. The replicas don't talk to each other and the poolers don't either. Every component has the knowledge it needs (through configuration) to do its job, and they do it well.</p> <p>The most impressive result is serving close to a million predictions with an average latency of less than 1ms. You might notice though that <code>950160.7</code> isn't quite one million, and that's true. We couldn't reach one million with 1000 clients, so we increased to 2000 and got our magic number: <strong>1,021,692.7 req/sec</strong>, with an average latency of <strong>1.7ms</strong>.</p> <h3 id=batching-predictions>Batching Predictions<a class=headerlink href=#batching-predictions title="Permanent link">¶</a></h3> <p>Batching is a proven method to optimize performance. If you need to get several data points, batch the requests into one query, and it will run faster than making individual requests.</p> <p>We should precede this result by stating that PostgresML does not yet have a batch prediction API as such. Our <code>pgml.predict()</code> function can predict multiple points, but we haven't implemented a query pattern to pass multiple rows to that function at the same time. Once we do, based on our tests, we should see a substantial increase in batch prediction performance.</p> <p>Regardless of that limitation, we still managed to get better results by batching queries together since Postgres needed to do less query parsing and searching, and we saved on network round trip time as well.</p> <p><center> <iframe frameborder=0 height=371 scrolling=no seamless src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRm4aEylX8xMNmO-HFFxr67gbZDQ8rh_vss1HvX0tWAUD_zxkwYYNhiBObT1LVe8m6ELZ0seOzmH0ZL/pubchart?oid=1506211879&format=interactive" width=600></iframe> </center></p> <p><center> <iframe frameborder=0 height=371 scrolling=no seamless src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRm4aEylX8xMNmO-HFFxr67gbZDQ8rh_vss1HvX0tWAUD_zxkwYYNhiBObT1LVe8m6ELZ0seOzmH0ZL/pubchart?oid=1488435965&format=interactive" width=600></iframe> </center></p> <p>If batching did not work at all, we would see a linear increase in latency and a linear decrease in throughput. That did not happen; instead, we got a 1.5x improvement by batching 5 predictions together, and a 1.2x improvement by batching 20. A modest success, but a success nonetheless.</p> <h3 id=graceful-degradation-and-queuing>Graceful Degradation and Queuing<a class=headerlink href=#graceful-degradation-and-queuing title="Permanent link">¶</a></h3> <p><center> <iframe frameborder=0 height=371 scrolling=no seamless src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRm4aEylX8xMNmO-HFFxr67gbZDQ8rh_vss1HvX0tWAUD_zxkwYYNhiBObT1LVe8m6ELZ0seOzmH0ZL/pubchart?oid=1396205706&format=interactive" width=600></iframe> </center></p> <p><center> <iframe frameborder=0 height=371 scrolling=no seamless src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRm4aEylX8xMNmO-HFFxr67gbZDQ8rh_vss1HvX0tWAUD_zxkwYYNhiBObT1LVe8m6ELZ0seOzmH0ZL/pubchart?oid=1300503904&format=interactive" width=600></iframe> </center></p> <p>All systems, at some point in their lifetime, will come under more load than they were designed for; what happens then is an important feature (or bug) of their design. Horizontal scaling is never immediate: it takes a bit of time to spin up additional hardware to handle the load. It can take a second, or a minute, depending on availability, but in both cases, existing resources need to serve traffic the best way they can.</p> <p>We were hoping to test PostgresML to its breaking point, but we couldn't quite get there. As the load (number of clients) increased beyond provisioned capacity, the only thing we saw was a gradual increase in latency. Throughput remained roughly the same. This gradual latency increase was caused by simple queuing: the replicas couldn't serve requests concurrently, so the requests had to patiently wait in the poolers.</p> <p><center> <a class=glightbox data-desc-position=bottom data-height=auto data-width=100% href=/images/illustrations/queueing.svg><img alt=Queuing src=/images/illustrations/queueing.svg></a> <br> <em>"What's taking so long over there!?"</em> </center></p> <p>Among many others, this is a very important feature of any proxy: it's a FIFO queue (first in, first out). If the system is underutilized, queue size is 0 and all requests are served as quickly as physically possible. If the system is overutilized, the queue size increases, holds as the number of requests stabilizes, and decreases back to 0 as the system is scaled up to accommodate new traffic.</p> <p>Queueing overall is not desirable, but it's a feature, not a bug. While autoscaling spins up an additional replica, the app continues to work, although a few milliseconds slower, which is a good trade off for not overspending on hardware.</p> <p>As the demand on PostgresML increases, the system gracefully handles the load. If the number of replicas stays the same, latency slowly increases, all the while remaining well below acceptable ranges. Throughput holds as well, as increasing number of clients evenly split available resources.</p> <p>If we increase the number of replicas, latency decreases and throughput increases, as the number of clients increases in parallel. We get the best result with 5 replicas, but this number is variable and can be changed as needs for latency compete with cost.</p> <h2 id=whats-next>What's Next<a class=headerlink href=#whats-next title="Permanent link">¶</a></h2> <p>Horizontal scaling and high availability are fascinating topics in software engineering. Needing to serve 1 million predictions per second is rare, but having the ability to do that, and more if desired, is an important aspect for any new system.</p> <p>The next challenge for us is to scale writes horizontally. In the database world, this means sharding the database into multiple separate machines using a hashing function, and automatically routing both reads and writes to the right shards. There are many possible solutions on the market for this already, e.g. Citus and Foreign Data Wrappers, but none are as horizontally scalable as we like, although we will incorporate them into our architecture until we build the one we really want.</p> <p>For that purpose, we're building our own open source <a href=https://github.com/levkk/pgcat/ >Postgres proxy</a> which we discussed earlier in the article. As we progress further in our journey, we'll be adding more features and performance improvements.</p> <p>By combining PgCat with PostgresML, we are aiming to build the next generation of machine learning infrastructure that can power anything from tiny startups to unicorns and massive enterprises, without the data ever leaving our favorite database.</p> <h2 id=methodology>Methodology<a class=headerlink href=#methodology title="Permanent link">¶</a></h2> <h3 id=ml>ML<a class=headerlink href=#ml title="Permanent link">¶</a></h3> <p>This time, we used an XGBoost model with 100 trees:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-0-1 id=__codelineno-0-1 name=__codelineno-0-1></a><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>pgml</span><span class=mf>.</span><span class=n>train</span><span class=p>(</span>
<a href=#__codelineno-0-2 id=__codelineno-0-2 name=__codelineno-0-2></a><span class=w>    </span><span class=s1>'flights'</span><span class=p>,</span>
<a href=#__codelineno-0-3 id=__codelineno-0-3 name=__codelineno-0-3></a><span class=w>    </span><span class=n>task</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=s1>'regression'</span><span class=p>,</span>
<a href=#__codelineno-0-4 id=__codelineno-0-4 name=__codelineno-0-4></a><span class=w>    </span><span class=n>relation_name</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=s1>'flights_mat_3'</span><span class=p>,</span>
<a href=#__codelineno-0-5 id=__codelineno-0-5 name=__codelineno-0-5></a><span class=w>    </span><span class=n>y_column_name</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=s1>'depdelayminutes'</span><span class=p>,</span>
<a href=#__codelineno-0-6 id=__codelineno-0-6 name=__codelineno-0-6></a><span class=w>    </span><span class=n>algorithm</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=s1>'xgboost'</span><span class=p>,</span>
<a href=#__codelineno-0-7 id=__codelineno-0-7 name=__codelineno-0-7></a><span class=w>    </span><span class=n>hyperparams</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=s1>'{"n_estimators": 100 }'</span><span class=p>,</span>
<a href=#__codelineno-0-8 id=__codelineno-0-8 name=__codelineno-0-8></a><span class=w>    </span><span class=n>runtime</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=s1>'rust'</span>
<a href=#__codelineno-0-9 id=__codelineno-0-9 name=__codelineno-0-9></a><span class=p>);</span>
</code></pre></div> <p>and fetched our predictions the usual way:</p> <div class=highlight><pre><span></span><code><a href=#__codelineno-1-1 id=__codelineno-1-1 name=__codelineno-1-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>pgml</span><span class=mf>.</span><span class=n>predict</span><span class=p>(</span>
<a href=#__codelineno-1-2 id=__codelineno-1-2 name=__codelineno-1-2></a><span class=w>    </span><span class=s1>'flights'</span><span class=p>,</span>
<a href=#__codelineno-1-3 id=__codelineno-1-3 name=__codelineno-1-3></a><span class=w>    </span><span class=k>ARRAY</span><span class=p>[</span>
<a href=#__codelineno-1-4 id=__codelineno-1-4 name=__codelineno-1-4></a><span class=w>        </span><span class=k>year</span><span class=p>,</span>
<a href=#__codelineno-1-5 id=__codelineno-1-5 name=__codelineno-1-5></a><span class=w>        </span><span class=n>quarter</span><span class=p>,</span>
<a href=#__codelineno-1-6 id=__codelineno-1-6 name=__codelineno-1-6></a><span class=w>        </span><span class=k>month</span><span class=p>,</span>
<a href=#__codelineno-1-7 id=__codelineno-1-7 name=__codelineno-1-7></a><span class=w>        </span><span class=n>distance</span><span class=p>,</span>
<a href=#__codelineno-1-8 id=__codelineno-1-8 name=__codelineno-1-8></a><span class=w>        </span><span class=n>dayofweek</span><span class=p>,</span>
<a href=#__codelineno-1-9 id=__codelineno-1-9 name=__codelineno-1-9></a><span class=w>        </span><span class=n>dayofmonth</span><span class=p>,</span>
<a href=#__codelineno-1-10 id=__codelineno-1-10 name=__codelineno-1-10></a><span class=w>        </span><span class=n>flight_number_operating_airline</span><span class=p>,</span>
<a href=#__codelineno-1-11 id=__codelineno-1-11 name=__codelineno-1-11></a><span class=w>        </span><span class=n>originairportid</span><span class=p>,</span>
<a href=#__codelineno-1-12 id=__codelineno-1-12 name=__codelineno-1-12></a><span class=w>        </span><span class=n>destairportid</span><span class=p>,</span>
<a href=#__codelineno-1-13 id=__codelineno-1-13 name=__codelineno-1-13></a><span class=w>        </span><span class=n>flight_number_marketing_airline</span><span class=p>,</span>
<a href=#__codelineno-1-14 id=__codelineno-1-14 name=__codelineno-1-14></a><span class=w>        </span><span class=n>departure</span>
<a href=#__codelineno-1-15 id=__codelineno-1-15 name=__codelineno-1-15></a><span class=w>    </span><span class=p>]</span>
<a href=#__codelineno-1-16 id=__codelineno-1-16 name=__codelineno-1-16></a><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>prediction</span>
<a href=#__codelineno-1-17 id=__codelineno-1-17 name=__codelineno-1-17></a><span class=k>FROM</span><span class=w> </span><span class=n>flights_mat_3</span><span class=w> </span><span class=k>LIMIT</span><span class=w> </span><span class=nv>:limit</span><span class=p>;</span>
</code></pre></div> <p>where <code>:limit</code> is the batch size of 1, 5, and 20.</p> <h4 id=model>Model<a class=headerlink href=#model title="Permanent link">¶</a></h4> <p>The model is roughly the same as the one we used in our previous <a href=/blog/postgresml-is-8x-faster-than-python-http-microservices>post</a>, with just one extra feature added, which improved R<sup>2</sup> a little bit.</p> <h3 id=hardware>Hardware<a class=headerlink href=#hardware title="Permanent link">¶</a></h3> <h4 id=client>Client<a class=headerlink href=#client title="Permanent link">¶</a></h4> <p>The client was a <code>c5n.4xlarge</code> box on EC2. We chose the <code>c5n</code> class to have the 100 GBit NIC, since we wanted it to saturate our network as much as possible. Thousands of clients were simulated using <a href=https://www.postgresql.org/docs/current/pgbench.html><code>pgbench</code></a>.</p> <h4 id=pgcat-pooler>PgCat Pooler<a class=headerlink href=#pgcat-pooler title="Permanent link">¶</a></h4> <p>PgCat, written in asynchronous Rust, was running on <code>c5.xlarge</code> machines (4 vCPUs, 8GB RAM) with 4 Tokio workers. We used between 1 and 35 machines, and scaled them in increments of 5-20 at a time.</p> <p>The pooler did a decent amount of work around parsing queries, making sure they are read-only <code>SELECT</code>s, and routing them, at random, to replicas. If any replica was down for any reason, it would route around it to remaining machines.</p> <h4 id=postgres-replicas_1>Postgres Replicas<a class=headerlink href=#postgres-replicas_1 title="Permanent link">¶</a></h4> <p>Postgres replicas were running on <code>c5.9xlarge</code> machines with 36 vCPUs and 72 GB of RAM. The hot dataset fits entirely in memory. The servers were intentionally saturated to maximum capacity before scaling up to test queuing and graceful degradation of performance.</p> <h4 id=raw-results>Raw Results<a class=headerlink href=#raw-results title="Permanent link">¶</a></h4> <p>Raw latency data is available <a href=https://static.postgresml.org/benchmarks/reads-latency.csv>here</a> and raw throughput data is available <a href=https://static.postgresml.org/benchmarks/reads-throughput.csv>here</a>.</p> <h2 id=call-to-early-adopters>Call to Early Adopters<a class=headerlink href=#call-to-early-adopters title="Permanent link">¶</a></h2> <p><a href=https://github.com/postgresml/postgresml/ >PostgresML</a> and <a href=https://github.com/levkk/pgcat/ >PgCat</a> are free and open source. If your organization can benefit from simplified and fast machine learning, get in touch! We can help deploy PostgresML internally, and collaborate on new and existing features. Join our <a href=https://discord.gg/DmyJP3qJ7U>Discord</a> or <a href=mailto:team@postgresml.org>email</a> us!</p> <p>Many thanks and ❤️ to all those who are supporting this endeavor. We’d love to hear feedback from the broader ML and Engineering community about applications and other real world scenarios to help prioritize our work. You can show your support by starring us on our <a href=https://github.com/postgresml/postgresml/ >Github</a>.</p> <h2 id=__comments>Comments</h2> <script async crossorigin=anonymous data-category=Announcements data-category-id=DIC_kwDOHJ_hQM4CQctz data-emit-metadata=0 data-input-position=top data-lang=en data-mapping=title data-reactions-enabled=1 data-repo=postgresml/postgresml data-repo-id=R_kgDOHJ_hQA data-strict=0 data-theme=light src=https://giscus.app/client.js>
</script> <script>
  var giscus = document.querySelector("script[src*=giscus]")

  /* Set palette on initial load */
  var palette = __md_get("__palette")
  if (palette && typeof palette.color === "object") {
    var theme = palette.color.scheme === "slate" ? "dark" : "light"
    giscus.setAttribute("data-theme", theme) 
  }

  /* Register event handlers after documented loaded */
  document.addEventListener("DOMContentLoaded", function() {
    var ref = document.querySelector("[data-md-component=palette]")
    ref.addEventListener("change", function() {
      var palette = __md_get("__palette")
      if (palette && typeof palette.color === "object") {
        var theme = palette.color.scheme === "slate" ? "dark" : "light"

        /* Instruct Giscus to change theme */
        var frame = document.querySelector(".giscus-frame")
        frame.contentWindow.postMessage(
          { giscus: { setConfig: { theme } } },
          "https://giscus.app"
        )
      }
    })
  })
</script> </article> </div> </div> <a class="md-top md-icon" data-md-component=top hidden href=#> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"></path></svg> Back to top </a> </main> <footer class=md-footer> <nav aria-label=Footer class="md-footer__inner md-grid"> <a aria-label="Previous: PostgresML is 8-40x faster than Python HTTP microservices" class="md-footer__link md-footer__link--prev" href=../postgresml-is-8x-faster-than-python-http-microservices/ rel=prev> <div class="md-footer__button md-icon"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> PostgresML is 8-40x faster than Python HTTP microservices </div> </div> </a> <a aria-label="Next: Team" class="md-footer__link md-footer__link--next" href=../../about/team/ rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Team </div> </div> <div class="md-footer__button md-icon"> <svg viewbox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright © 2022 PostgresML Team </div> </div> <div class=md-social> <a class=md-social__link href=https://github.com/postgresml/postgresml rel=noopener target=_blank title=github.com> <svg viewbox="0 0 496 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg> </a> <a class=md-social__link href=https://discord.gg/DmyJP3qJ7U rel=noopener target=_blank title=discord.gg> <svg viewbox="0 0 640 512" xmlns=http://www.w3.org/2000/svg><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M524.531 69.836a1.5 1.5 0 0 0-.764-.7A485.065 485.065 0 0 0 404.081 32.03a1.816 1.816 0 0 0-1.923.91 337.461 337.461 0 0 0-14.9 30.6 447.848 447.848 0 0 0-134.426 0 309.541 309.541 0 0 0-15.135-30.6 1.89 1.89 0 0 0-1.924-.91 483.689 483.689 0 0 0-119.688 37.107 1.712 1.712 0 0 0-.788.676C39.068 183.651 18.186 294.69 28.43 404.354a2.016 2.016 0 0 0 .765 1.375 487.666 487.666 0 0 0 146.825 74.189 1.9 1.9 0 0 0 2.063-.676A348.2 348.2 0 0 0 208.12 430.4a1.86 1.86 0 0 0-1.019-2.588 321.173 321.173 0 0 1-45.868-21.853 1.885 1.885 0 0 1-.185-3.126 251.047 251.047 0 0 0 9.109-7.137 1.819 1.819 0 0 1 1.9-.256c96.229 43.917 200.41 43.917 295.5 0a1.812 1.812 0 0 1 1.924.233 234.533 234.533 0 0 0 9.132 7.16 1.884 1.884 0 0 1-.162 3.126 301.407 301.407 0 0 1-45.89 21.83 1.875 1.875 0 0 0-1 2.611 391.055 391.055 0 0 0 30.014 48.815 1.864 1.864 0 0 0 2.063.7A486.048 486.048 0 0 0 610.7 405.729a1.882 1.882 0 0 0 .765-1.352c12.264-126.783-20.532-236.912-86.934-334.541ZM222.491 337.58c-28.972 0-52.844-26.587-52.844-59.239s23.409-59.241 52.844-59.241c29.665 0 53.306 26.82 52.843 59.239 0 32.654-23.41 59.241-52.843 59.241Zm195.38 0c-28.971 0-52.843-26.587-52.843-59.239s23.409-59.241 52.843-59.241c29.667 0 53.307 26.82 52.844 59.239 0 32.654-23.177 59.241-52.844 59.241Z"></path></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.top", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../../assets/javascripts/bundle.5a2dcb6a.min.js></script> <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body> </html>