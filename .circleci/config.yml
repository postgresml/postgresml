# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

jobs:
  extension:
    working_directory: pgml-extension
    docker:
      - image: ubuntu:jammy # Ubuntu 22.10
    # Add steps to the job
    # See: https://circleci.com/docs/2.0/configuration-reference/#steps
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            apt-get update && \
            DEBIAN_FRONTEND=noninteractive TZ=Etc/UTC apt-get install -y \
              curl \
              build-essential \
              libopenblas-dev \
              clang \
              python3-dev \
              libpython3-dev \
              postgresql \
              postgresql-server-dev-14 \
              pkg-config
      - run:
          name: Install Rust
          command: |
            curl https://sh.rustup.rs -sSf | sh -s -- -y;
            echo 'export PATH="${PATH}:~/.cargo/bin"' >> "$BASH_ENV"
      - run:
          name: Install tcdi/pgx
          command: "cargo install cargo-pgx; cargo pgx init --pg14 /usr/bin/pg_config"
      - restore_cache:
          key: extension-{{ checksum "pgml-extension/Cargo.toml" }}
      - run:
          name: Tests
          command: "cargo pgx test --release"
      - save_cache:
          key: extension-{{ checksum "pgml-extension/Cargo.toml" }}
          paths:
          - target
          - ~/.cargo
          - ~/.pgx

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  tests:
    jobs:
      - extension
