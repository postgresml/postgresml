# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

orbs:
  rust: cimg/base:2022.10 # Ubuntu 22.10

jobs:
  extension:
    working_directory: pgml-extension

    # Add steps to the job
    # See: https://circleci.com/docs/2.0/configuration-reference/#steps
    steps:
      - checkout
      - run:
          name: Install Rust
          command: |
            curl https://sh.rustup.rs -sSf | sh -s -- -y;
            echo 'export PATH="${PATH}:~/.cargo/bin"' >> "$BASH_ENV"
      - run:
          name: Install Postgres
          command: "apt-get update && apt-get install -y postgresql"
      - run:
          name: Install tcdi/pgx
          command: "cargo install cargo-pgx; cargo pgx init --pg14 /usr/bin/pg_config"
      - restore_cache:
          key: extension-{{ checksum "pgml-extension/Cargo.toml" }}
      - run:
          name: Tests
          command: "cargo pgx test --release"
      - save_cache:
          key: extension-{{ checksum "pgml-extension/Cargo.toml" }}
          paths:
          - target
          - ~/.cargo
          - ~/.pgx

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
# workflows:
#   end-to-end-tests:
#     jobs:
#       - rust/lint-test-build:
#           release: true
#           working_directory: pgml-extension
#       # - extension
#       # - dashboard
