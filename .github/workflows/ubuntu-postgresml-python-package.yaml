name: Ubuntu PostgresML Python package

on:
  workflow_dispatch:
    inputs:
      packageVersion:
        default: "2.10.0"

jobs:
  postgresml-python:
    strategy:
      fail-fast: false # Let the other job finish
      matrix:
        include:
          # Ubuntu 24.04 LTS (Noble)
          - os: "ubuntu-24.04"
            ubuntu_version: "noble"
            arch: "amd64"
          - os: "ubuntu-24.04-arm"
            ubuntu_version: "noble"
            arch: "arm64"
          # Ubuntu 22.04 LTS (Jammy)
          - os: "ubuntu-22.04"
            ubuntu_version: "jammy"
            arch: "amd64"
          - os: "ubuntu-22.04-arm"
            ubuntu_version: "jammy"
            arch: "arm64"
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v3
    - name: Install dependencies
      env:
        DEBIAN_FRONTEND: noninteractive
        TZ: Etc/UTC
      run: |
        sudo apt-get install -y software-properties-common
        sudo add-apt-repository ppa:apt-fast/stable --yes
        sudo add-apt-repository ppa:deadsnakes/ppa --yes
        sudo apt update

        sudo apt-get install -y apt-fast
        sudo apt-get update && sudo apt-fast install -y \
          python3.11 \
          python3-pip \
          libpython3.11-dev \
          python3.11-dev

        sudo dpkg --configure -a
    - name: Build and release package
      env:
        AWS_ACCESS_KEY_ID: ${{ vars.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: ${{ vars.AWS_DEFAULT_REGION }}
      run: |
        bash packages/postgresml-python/release.sh ${{ inputs.packageVersion }}
